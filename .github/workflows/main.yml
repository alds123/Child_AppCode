name: Android UI Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: macos-13

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        distribution: 'temurin'
        java-version: '17'

    - name: Download Android SDK tools
      run: |
        echo "y" | sdkmanager --install "platform-tools" "platforms;android-34" "build-tools;34.0.0" "emulator" "system-images;android-34;google_apis;x86_64"

    - name: Create and start emulator
      run: |
        echo "no" | avdmanager create avd -n API_36 -k "system-images;android-34;google_apis;x86_64" --force
        $ANDROID_HOME/emulator/emulator -avd API_36 -no-snapshot -noaudio -no-window -gpu swiftshader_indirect &
        adb wait-for-device
        adb shell input keyevent 82
        adb devices

    - name: Install Appium
      run: |
        npm install -g appium
        appium -v

    - name: Install Appium drivers
      run: |
        appium driver install uiautomator2

    - name: Start Appium server
      run: |
        nohup appium --base-path /wd/hub > appium.log 2>&1 &
        sleep 10

    - name: Install and configure Appium Settings
      run: |
        curl -L -o appium-settings.apk https://github.com/appium/io.appium.settings/releases/latest/download/settings_apk-debug.apk
        adb install -r appium-settings.apk

        echo "Unlocking screen..."
        adb shell input keyevent 82

        echo "Launching Appium Settings app..."
        adb shell monkey -p io.appium.settings -c android.intent.category.LAUNCHER 1
        sleep 10

        echo "Waiting for UnicodeIME to become available..."
        retries=10
        while ! adb shell ime list -a | grep -q 'io.appium.settings/.UnicodeIME'; do
          echo "UnicodeIME not yet available... waiting..."
          sleep 2
          retries=$((retries - 1))
          if [ "$retries" -le 0 ]; then
            echo "UnicodeIME not found after retries. Exiting."
            exit 1
          fi
        done

        echo "Enabling UnicodeIME..."
        adb shell ime enable io.appium.settings/.UnicodeIME
        adb shell ime set io.appium.settings/.UnicodeIME

        echo "Granting permissions..."
        adb shell appops set io.appium.settings RUN_IN_BACKGROUND allow || true
        adb shell pm grant io.appium.settings android.permission.SET_ANIMATION_SCALE || true
        adb shell pm grant io.appium.settings android.permission.CHANGE_CONFIGURATION || true
        adb shell pm grant io.appium.settings android.permission.WRITE_SECURE_SETTINGS || true

    - name: Build and run tests
      run: mvn clean test
