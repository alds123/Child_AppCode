name: Android Emulator CI

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Set up Java 17
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: '17'

    - name: Set up Android SDK
      uses: android-actions/setup-android@v3

    - name: Install system image
      run: |
        echo "y" | sdkmanager --install \
          "platform-tools" \
          "platforms;android-34" \
          "build-tools;34.0.0" \
          "emulator" \
          "system-images;android-34;google_apis;x86_64"

    - name: Create AVD
      run: |
        echo "no" | avdmanager create avd -n test -k "system-images;android-34;google_apis;x86_64" --device "pixel"

    - name: Start emulator
      run: |
        nohup emulator -avd test -no-audio -no-window -gpu off &
        adb wait-for-device
        boot_completed=""
        until [[ "$boot_completed" == "1" ]]; do
          boot_completed=$(adb shell getprop sys.boot_completed | tr -d '\r')
          echo "Waiting for emulator to boot..."
          sleep 5
        done
        echo "âœ… Emulator booted"

    - name: Run Appium tests
      run: mvn clean test
