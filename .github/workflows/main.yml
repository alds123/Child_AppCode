name: Android Emulator CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 35

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: 17

      - name: Install AVD and System Image
        run: |
          echo "y" | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --install "system-images;android-34;google_apis;x86_64"

      - name: Create AVD
        run: |
          echo "no" | avdmanager create avd -n API_34 -k "system-images;android-34;google_apis;x86_64" --device "pixel"
          sleep 5
          if [ -f ~/.android/avd/API_34.avd/config.ini ]; then
            echo "hw.gpu.enabled=yes" >> ~/.android/avd/API_34.avd/config.ini
          else
            echo "AVD config.ini not found!" && exit 1
          fi

      - name: Start Emulator
        run: |
          nohup $ANDROID_HOME/emulator/emulator -avd API_34 -no-window -no-audio -accel off > /dev/null 2>&1 &
          sleep 60

      - name: Wait for Emulator to Boot
        run: |
          adb wait-for-device
          adb devices
          timeout 600 bash -c "until adb shell getprop sys.boot_completed | grep -m 1 '1'; do echo 'Waiting for emulator...'; sleep 10; done"
          adb shell input keyevent 82
          echo "Emulator is ready"

      - name: Run Tests
        run: mvn clean test
