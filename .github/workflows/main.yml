name: Android Emulator CI

on:
  push:
    branches: [ main ]

jobs:
  android-tests:
    runs-on: macos-13
    steps:
      - uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Install Android SDK Command-line Tools
        run: |
          brew install --cask android-commandlinetools
          export ANDROID_SDK_ROOT=$HOME/Library/Android/sdk
          mkdir -p $ANDROID_SDK_ROOT/cmdline-tools/latest
          cp -R /usr/local/share/android-commandlinetools/* $ANDROID_SDK_ROOT/cmdline-tools/latest/

          echo "ANDROID_SDK_ROOT=$ANDROID_SDK_ROOT" >> $GITHUB_ENV
          echo "$ANDROID_SDK_ROOT/emulator" >> $GITHUB_PATH
          echo "$ANDROID_SDK_ROOT/platform-tools" >> $GITHUB_PATH
          echo "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin" >> $GITHUB_PATH

      - name: Install SDK Packages
        run: |
          sdkmanager --sdk_root=$ANDROID_SDK_ROOT --licenses
          sdkmanager --sdk_root=$ANDROID_SDK_ROOT \
            "platform-tools" \
            "platforms;android-34" \
            "system-images;android-34;google_apis;x86_64" \
            "emulator"

      - name: Create and Start Emulator
        run: |
          avdmanager --verbose create avd --force --name test_emulator --package "system-images;android-34;google_apis;x86_64" --device "pixel"
          nohup emulator -avd test_emulator -no-snapshot -no-window -no-audio &
          adb wait-for-device
          adb shell input keyevent 82

      - name: Run Tests
        run: mvn clean test
