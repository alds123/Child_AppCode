name: Android UI Tests

on:
  push:
    branches: [main]
  pull_request:

jobs:
  android-tests:
    runs-on: macos-13
    timeout-minutes: 30

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Java
      uses: actions/setup-java@v3
      with:
        distribution: temurin
        java-version: 17

    - name: Set environment variables
      run: |
        echo "ANDROID_HOME=$HOME/Library/Android/sdk" >> $GITHUB_ENV
        echo "PATH=$HOME/Library/Android/sdk/emulator:$HOME/Library/Android/sdk/platform-tools:$HOME/Library/Android/sdk/cmdline-tools/latest/bin:$PATH" >> $GITHUB_ENV

    - name: Accept SDK licenses
      run: yes | $HOME/Library/Android/sdk/cmdline-tools/latest/bin/sdkmanager --licenses

    - name: Install required SDK packages
      run: |
        sdkmanager "platform-tools" "platforms;android-34" "emulator" "system-images;android-34;google_apis;x86_64"

    - name: Create Android emulator
      run: |
        echo "no" | avdmanager create avd -n test_emulator -k "system-images;android-34;google_apis;x86_64" --device "pixel"

    - name: Start Android emulator
      run: |
        nohup emulator -avd test_emulator -no-window -no-audio -no-boot-anim -gpu swiftshader_indirect > emulator.log 2>&1 &

    - name: Wait for emulator to boot
      run: .github/scripts/wait-for-emulator.sh

    - name: Install Appium Settings APK
      run: |
        curl -L -o appium-settings.apk https://github.com/appium/io.appium.settings/releases/latest/download/settings_apk-debug.apk
        adb install appium-settings.apk

    - name: Install Appium and UiAutomator2 Driver
      run: |
        npm install -g appium
        appium driver install uiautomator2

    - name: Start Appium Server
      run: |
        appium --log-level info --base-path /wd/hub --port 4723 > appium.log 2>&1 &
        sleep 10

    - name: Run Tests
      run: mvn clean test
